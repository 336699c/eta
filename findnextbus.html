<script>
//v9.0

var input = document.URL.split("findnextbus.html?")[1];
//var input = "21,outbound,kmb,15";
input = input.split(",");
    
function httpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}

var routelist = [];
var pointer = parseInt(input[3]);
function data(e){
var rr = JSON.parse(e)["data"];
rr.forEach(f=>{routelist.push(f["stop"]);});
httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/eta/"+input[2]+"/"+routelist[pointer]+"/"+input[0],function (e){grabeta(e)});
}

var lasteta = "9999";
var valid = null;
var data1 = [];
function grabeta(e){
var rr = JSON.parse(e)["data"];
if((!rr[0] || rr[0]["eta"]<lasteta) && new Date(rr[0]["eta"]).getTime() > new Date().getTime()&& pointer>0){
pointer--;
lasteta = (rr[0]?rr[0]["eta"]:lasteta);
valid = [rr[0]["stop"],rr[0]["seq"],rr[0]["route"],rr[0]["dest_tc"],rr[0]["rmk_tc"]];
var x = "*下一班 "+ valid[2] +"（"+timeparse(lasteta)+", "+(parseInt(input[3])-parseInt(valid[1]))+"站）\n位於 #"+ valid[1] +(valid[4]?"\n"+valid[4]:"");
window.AppInventor.setWebViewString (x);
httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/eta/"+input[2]+"/"+routelist[pointer]+"/"+input[0],function (e){grabeta(e)});
}else{
if(rr[0]["seq"]){
httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/stop/"+valid[0],function (e){output(e)});
}
}
}

function timeparse(e){
if (e===null)return "";
return ((Math.abs((new Date(e).getTime() - new Date().getTime() )/1000)<90)?(Math.floor((new Date(e).getTime() - new Date().getTime() )/1000)+" 秒"):(Math.floor((new Date(e).getTime() - new Date().getTime() )/60000))+" 分")
}


function output(e){
var rr = JSON.parse(e)["data"];
var x = "下一班 "+ valid[2] +"（"+timeparse(lasteta)+", "+(parseInt(input[3])-parseInt(valid[1]))+"站）\n位於 "+ valid[1] +". "+rr["name_tc"]+ "\n前往 " +valid[3]+(valid[4]?"\n"+valid[4]:"");
document.write(x);
window.AppInventor.setWebViewString (x);
}

//ctb

//kmb
var result=[0];
var buspos=[];
var lastseq=0;
function data2(e){
var rr = JSON.parse(e)["data"];
for (var i in rr){
if(rr[i]["dir"] == input[1]){
if(lastseq!=rr[i]["seq"]){
lastseq = rr[i]["seq"];
if (rr[i]["eta"]<result[result.length-1][0])buspos.push(rr[i]["seq"]);
result.push([rr[i]["eta"],rr[i]["rmk_tc"],rr[i]["seq"],rr[i]["dest_tc"]]);
}
}
}
buspos = buspos.filter(e=>e<parseInt(input[3]));
buspos.unshift(1);
lastseq = buspos.pop();


if(input[1]=="O")input[1]="outbound";
if(input[1]=="I")input[1]="inbound";
httpGet("https://data.etabus.gov.hk/v1/transport/kmb/route-stop/"+input[0]+"/"+input[1]+"/1",function (e){rt_stop(e)});
}

function rt_stop(e){
var rr = JSON.parse(e)["data"][lastseq-1]["stop"];
httpGet("https://data.etabus.gov.hk/v1/transport/kmb/stop/"+rr,function (e){stop(e)});
}

function stop(e){
var rr = JSON.parse(e)["data"]["name_tc"];
var tt = result[lastseq];
var x = "下一班 "+ input[0] +"（"+timeparse(tt[0])+", "+(-parseInt(tt[2])+parseInt(input[3]))+"站）\n位於 "+ tt[2] +". "+rr+ "\n前往 " +tt[3]+(tt[1]?"\n"+tt[1]:"");
document.write(x);
window.AppInventor.setWebViewString (x);
}

if(input[2]=="KMB" || input[2]=="kmb"){
if(input[1]=="outbound")input[1]="O";
if(input[1]=="inbound")input[1]="I";
httpGet("https://data.etabus.gov.hk/v1/transport/kmb/route-eta/"+input[0]+"/1",function (e){data2(e)});
}else{
if(input[1]=="O")input[1]="outbound";
if(input[1]=="I")input[1]="inbound";
httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/route-stop/"+input[2]+"/"+input[0]+"/"+input[1],function (e){data(e)});
}



</script>
