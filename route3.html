<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
<link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet"/>
<link rel="icon" type="image/x-icon" href="/eta/icon/icon.png">

<link rel="stylesheet" href="script/main.css">
<link rel="stylesheet" href="script/formatETAString.css">
<link href="https://fonts.cdnfonts.com/css/seven-segment" rel="stylesheet">
<style>
body{
	height:100%;
}


.ROUTESTOP{
	background-color:#fff;
	overflow-y:auto;
	width:100%;
	height: flex-content;
	flex:5;
}

div.route{
  position: -webkit-sticky; /* Safari */
  position: sticky;

  display:flex;
  flex-direction:column;
  background-color:#b4c4ff;
  width:100%;
}

td.s1{
	width:30px;
}
td.s2{
	width:calculate(100%-600px);
	font-size: 1.7em;
}


.rss{
background-color: #ffffff;
border: 0px;
margin:0px;
left:0px;
padding:0 0 0 1px;
width:100%;
}

.stopid{
color: gray;
font-family:'Helvetica';
width:6%;
}

.stopname2{
font-family:'Helvetica';
font-size:1.1em;
text-align: left;
width:90%;
}

tbody{
width:100%
}

.stoptable{
width:100%;
text-align: left;
margin-left:0;
}

.stopname3{
width:65%
}
.eta{
width:30%
}
.bus{
width:50px
}


iframe{
width:100%;
height:400px;
}

#overlay {
  position: fixed; /* Sit on top of the page content */
  display: none; /* Hidden by default */
  width: 100%; /* Full width (cover the whole page) */
  height: 100%; /* Full height (cover the whole page) */
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.8); /* Black background with opacity */
  z-index: 2; /* Specify a stack order in case you're using a different order for other elements */
  overflow-y:scroll;
}

.rev{
width:50px;
height:100%;
background-color:#fff2;
border:none;
}


td.s2,td.s3,td.s4{
padding: 0 0 0 0; /* Padding inside cells */
text-align: left; /* Align text to the left */
border: 0px;
}

td.s3, td.s4{
width:50px;
height:100%;
text-align: right;
}

td.s2{
width:100%;
height:100%;
}

.img2{
width: 75%; /* Make images responsive */
max-height: 150px; /* Limit the maximum height */
height: auto; /* Maintain aspect ratio */
}


div.flex-vert{
	flex-direction:column;
}	

div.StopSelectionDIV{
	display:flex;
	width:100%;
	background-color: #f0f0f0;
	border: none; /* Remove default border */
	border-radius: 6px; /* Rounded corners */
}
	
	
iframe{
border: none; /* Remove default border */
}

button.TimerSettings{
width:50px;
height:100%;
font-family: 'Seven Segment', sans-serif;
font-size: 22px;
font-weight: 500;
color:#ffffff;
background-color:#fff2;
border:none;
margin:0px;
}

button.TimerSettingsLong{
	width:70px;
}

button.bookmark{
	text-align: left; width:100%; border:1px
}

.action-btn {
	flex: 1;
	background-color: #f8f9fa;
	border: 1px solid #dee2e6;
	border-radius: 8px;
	padding: 10px;
	text-align: center;
	cursor: pointer;
	transition: all 0.3s;
	font-size: 14px;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	margin-top: 5px;
	margin-left: 5px;
	margin-right: 5px;
	margin-bottom: 5px;
}

/*footer panel*/
div.tab_panel{
  position: -webkit-sticky; /* Safari */
  position: sticky;

  display:flex;
  background-color:#fff;
  width:100%;
}
.content{
  	flex-direction:column;
	display:flex;
	overflow-y:scroll;
	height:100%;
}
.tab {
	flex: 1;
	text-align: center;
	padding: 12px 0;
	font-size: 14px;
	color: #666;
	border-bottom: 3px solid transparent;
	transition: all 0.3s;
}

.tab.active {
	color: #66e;
	border-bottom-color: #66e;
	font-weight: bold;
}

button.footerButton{
	width:75px;
	height:50px;
	background-color:#aaaa;
	border:none;
}
.content_container{
	background-color:#fff;
	width:100%;
	height: 100%;
	display:none;
	flex:5;
}
.content_container.active{
	display:block;
}
#iframe.ROUTENOTE_iframe{
	width:100%;
	height:100%;
	border:none;
	overflow-y:auto;
	overflow-x:hidden;
	display:flex;
	flex:5;
}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>


</head>
<body>

<div class="PRE-container">
<div id="ROUTESTOP_header" class="route">
		<table id="rttable" class="rttable"></table>
</div>
<div class="tab_panel">
	<div class="tab active" data-view="ROUTESTOP" id="TAB_ROUTESTOP">Ë∑ØÁ∑ö</div>
	<div class="tab" data-view="ROUTEMAP" id="TAB_ROUTEMAP">Âú∞Âúñ</div>
	<div class="tab" data-view="ROUTENOTE" id="TAB_ROUTENOTE">ÂÇôË®ª</div>
</div>
<div class="content">
	<div class="content_container active" id="ROUTESTOP">
		<div class="stops">
			<table id="stoptable" class="stoptable"></table>
		</div>
	</div>
	<div class="content_container" id="ROUTEMAP">
		<div id="ROUTEMAP_container"></div>
	</div>
	<div class="content_container" id="ROUTENOTE">
		<iframe id="ROUTENOTE_iframe">	</iframe>
	</div>
</div>



<div id="overlay">
	<button onclick="overlay_off()" style="float: right; width:40px; height:40px; background-color:#faa; font-size:20px; border-radius: 50px"> X </button>
	<br>
	<div>
	<table id="B" width=100%></table>
	</div>
</div>

</div>

<script src="script/hk-bus-crawling-converter.js"></script>
<script src="script/utils.js"></script>
<script src="script/bundles.js"></script>

<script>
var element_init = {"ROUTEMAP":false,"TEST":1}
function changePage(viewId,element){
	if(!element)element = document.getElementById("TAB_"+viewId);
	const funcs = {
	"ROUTESTOP": (()=>{}),
	"ROUTEMAP": (()=>{iframe_map_handler("ROUTEMAP",true)}),
	"ROUTENOTE": (()=>{
		if(RT_dt.cos.includes("ctb"))$("#ROUTENOTE_iframe").attr("src",`https://mobile.citybus.com.hk/nwp3/getnotice.php?id=${RT_dt.route}`);
	}),
	}
	// ÁßªÈô§ÊâÄÊúâÊ¥ªÂä®Áä∂ÊÄÅ
	document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
	document.querySelectorAll('.content > div').forEach(view => view.classList.remove('active'));

	// Ê∑ªÂä†ÂΩìÂâçÊ¥ªÂä®Áä∂ÊÄÅ
	if(element)element.classList.add('active');
	//Object.keys(funcs).forEach(g=>{$("#"+g).css("display",viewId==g?"block":"none")});
	document.querySelector(`#${viewId}`).classList.add('active');

	if(!element_init[viewId]){
		element_init[viewId] = true;
		funcs[viewId]();
	}
}
document.querySelectorAll('.tab').forEach(tab => {
	tab.addEventListener('click', function() {
		changePage(this.getAttribute('data-view'),this)
		
	});
});


function overlay_on(xid){
var bookmarks = localStorage.getItem('bookmarks') || "[]";
bookmarks = JSON.parse(bookmarks);
while(document.getElementById("B").childNodes.length>0){document.getElementById("B").childNodes[0].remove()};
bookmarks.push({name:"Êñ∞Êõ∏Á∞Ω",stops:[]});

var rownum = 0;
bookmarks.forEach((data,i)=>{
	if(data.stops.flat().includes(xid))return;

    var Row = document.getElementById("B").insertRow(rownum++);
	var but = Row.insertCell(0).appendChild(document.createElement('button'));
	but.className = "bookmark";
	but.innerHTML = `<pre style="display: inline;font-size:20px;">Êõ∏Á∞Ω${i} </pre>
	<label style="display: inline;font-size:10px;"> ${data.stops.map(w=>BusCrawling.getStopData(w[0]).name_tc).join("„ÄÅ<br>")} </label>`

	but.addEventListener('click', function() {
		var bookmarks = localStorage.getItem('bookmarks') || "[]";
		bookmarks = JSON.parse(bookmarks);

		if(bookmarks[i]){
			bookmarks[i].stops.push(BusCrawling.getSameStop(xid));
		}else{
			bookmarks.push({name:`Êõ∏Á∞Ω ${i}`,stops:[BusCrawling.getSameStop(xid)]});
		}
		localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
		alert(`Â∑≤Êñ∞Â¢û ${BusCrawling.getStopData(xid).name_tc} Ëá≥Êõ∏Á∞Ω#${i}`);
		document.getElementById("overlay").style.display = "none";
	})
    });
	
document.getElementById("overlay").style.display = "block";
}

function overlay_off(){
	document.getElementById("overlay").style.display = "none";
}
</script>

<script>
var BusCrawling = new BusCrawling();
var BusCrawlingData;
BusCrawling.data().then(res=>{BusCrawlingData=res;regen()});

var ETAList = new ETAList();
var RT_dt = {};

var RT_data = [];


const bilingual = localStorage.getItem('bilingual') === 'true';
const lang = bilingual?"tc": localStorage.getItem('language') || "tc";
const lang2 = lang=="tc"?"zh":lang;

//MODE_1 byroute INIT
var TimeDisplay = false;

function TimerSettings(){
	TimeDisplay = !TimeDisplay;
	if(TimeDisplay){
		$("#TimerSettings").addClass("TimerSettingsLong");
		$("#TimerSettings")[0].innerHTML = "";
	}
	else {
		$("#TimerSettings").removeClass("TimerSettingsLong");
		$("#TimerSettings")[0].innerHTML = `<img src="/eta/icon/time_${(TimeDisplay?"act":"cd")}.png" class="img2">`;
	}
}

function regen(){
	console.log(decodeURI(document.location.href.split("?")[1]));
	RT_dt.data = BusCrawlingData.routeList[decodeURI(document.location.href.split("?")[1])];
	RT_dt.stops = Object.values(RT_dt.data.stops)[0];
	RT_dt.costops = Object.values(RT_dt.data.stops)[1];
	RT_dt.route = RT_dt.data.route;
	RT_dt.bound = Object.values(RT_dt.data.bound)[0];
	RT_dt.bounds = RT_dt.data.bound;
	RT_dt.serviceType = RT_dt.data.serviceType;
	RT_dt.co = RT_dt.data.co.join("+").toUpperCase();
	RT_dt.cos = RT_dt.data.co;
	RT_dt.repeat = RT_dt.stops.filter((w,i)=>RT_dt.stops.indexOf(w) != i);
	console.log(RT_dt.repeat);

	RT_data = Object.values(RT_dt.data.stops)[0];

	var resultT = document.getElementById("rttable").insertRow();
	var s3 = resultT.insertCell(0);
	var s4 = resultT.insertCell(0);
	var s2 = resultT.insertCell(0);
	var s1 = resultT.insertCell(0);
	

	let opposite = BusCrawling.getOppositeRoute(RT_dt.cos,RT_dt.route,RT_dt.bounds[RT_dt.cos[0]]);
	if(opposite.length>0)s3.innerHTML = `<a href="route3.html?${
	BusCrawling.getOppositeRoute(RT_dt.cos,RT_dt.route,RT_dt.bounds[RT_dt.cos[0]])[0][0]}"><button class="rev"><img src="/eta/icon/route_rev.png" class="img2"></button></a>`
	
	s4.innerHTML = `<button class="TimerSettings" id="TimerSettings" onclick="TimerSettings()"><img src="/eta/icon/time_cd.png" class="TimerDisplay img2"></button>`
	document.title = `${RT_dt.route}  ${RT_dt.data.dest.zh}`;
	s2.innerHTML = `<label style="font-family: 'Helvetica';font-size:0.9em"><b>${RT_dt.route.padEnd(4," ")}</b> <label style="font-size:0.75em"><small><small>${_bundles.to[lang]} </small></small>${RT_dt.data.dest[lang2]}</label></label>`
	s1.className ="s1";
	s2.className ="s2";
	s3.className ="s3";
	s4.className ="s4";
	s1.innerHTML = `<img src="/eta/icon/${_T.busIMG(RT_dt.co,RT_dt.route)}.png" style="width:30px">`
	
	var stoplist = document.getElementById("stoptable");
	RT_dt.stopNickname = [];
	RT_dt.stops.forEach((w,i)=>{
		var s = stoplist.insertRow().insertCell(0);
		s.className = "rss";
		s.id = "rss_"+w;

		var stopName = BusCrawlingData.stopList[w].name[lang2];
		var k,displayName=[stopName,""];
		
		if(k=stopName.split(","),k.length>1){
			displayName = [k[0],k.slice(1).join(",")];
		}else if(/\([A-Za-z]+\d+\)/.test(stopName)){
			displayName = [stopName.replace(/\([A-Za-z]+\d+\)/g,""),stopName.match(/\([A-Za-z]+\d+\)/g).join("")];
		}
		if(/.+ËΩâËªäÁ´ô ?- ?/.test(displayName[0])){
			displayName[1] = "> BBI: " + displayName[0].match(/(.+)ËΩâËªäÁ´ô ?- ?/)[1] + "ËΩâËªäÁ´ô " + displayName[1];
			displayName[0] = displayName[0].replace(/.+ËΩâËªäÁ´ô ?- ?/,"");
		}
		if(RT_dt.co=="KMB" && lang=="en")displayName[0] = BusCrawling.toSentenceCase(displayName[0]);
		const stopNumber = localStorage.getItem('stopNumber') === 'true';
		RT_dt.stopNickname.push(displayName[0]);

		s.innerHTML = `<button onclick="click2('${w}', ${i+1}, ${RT_dt.costops?"'"+RT_dt.costops[i]+"'":""})" class="rss"><table class="stoptable"><td class="stopid2"><label class="stopid">${i+1}</label></td><td class="stopname3">
			<label class="stopname2"><big>${displayName[0]}</big>${RT_dt.data.fares&&RT_dt.data.fares[i]?"<br>" + _bundles.fare[lang]+": $"+RT_dt.data.fares[i]:""}<br><small><small>${displayName[1]} ${!stopNumber ? "" : w + (RT_dt.costops?" "+Object.values(RT_dt.data.stops)[1][i]:"")}</small></small></label></td></div>
			<td class="bus" id="bus_${w}_${i+1}"> </td><td class="eta" id="eta_${w}_${i+1}"></td></table></button><div id="stop_${w}">`
	});
	getETA();
}

//MODE 1 ETA
var ETA_RESULT={};
var COJOIN_ETA=false;
var counter = 0;


function apply_eta(s){
	/*RawETA[]*/ s = ETAList.byroute(RT_dt.cos, RT_dt.route, RT_dt.bounds);
	s.forEach((w,i)=>{
		if(!document.getElementById("bus_"+w.stop+"_"+w.seq))return;
		document.getElementById("bus_"+w.stop+"_"+w.seq).innerHTML = (()=>{switch(w.route_bus){
			case 0:
				return "";
			break;
			case 1:
				return `<img src="/eta/icon/${_T.busIMG(w.data()[0].co,RT_dt.route)}.png" style="width:30px">`;
			break;
			default:
				return `<div style="position:relative"><img src="/eta/icon/${_T.busIMG(w.data()[0].co,RT_dt.route)}.png" style="width:30px; filter:brightness(60%)">
					<div style="position:absolute;left: 7px;top: 1px"><span style="font-size:18px;font-weight:bold;color:#fff;">
						<small><small>x</small></small>${w.route_bus}
						</span></div>
						</div>`;
			break;	
		}
		})();
		
		document.getElementById("eta_"+w.stop+"_"+w.seq).innerHTML = w.formatETAString({mode:TimeDisplay?1:0, cos:RT_dt.cos.length>1, small:true});
	});
}

//MODE 1 
function click2(s,n,w){
document.getElementById("stop_"+s).innerHTML = `
<div class="StopSelectionDIV flex-vert">
<div class="StopSelectionDIV">
		<button onclick="overlay_on('${s}')" class="action-btn">
			üîñ<br>Êõ∏Á∞Ω
		</button>
		<button onclick="changePage('ROUTEMAP'),__MARKER_STATS.markers[${n-1}].openPopup(),__MARKER_STATS.map.setView(__MARKER_STATS.markers[${n-1}].getLatLng(),16)" class="action-btn">
			üó∫Ô∏è<br>Âú∞Âúñ
		</button>
		<button onclick="iframe_handler('${s}',1,'${w}')" class="action-btn">
			‚áÑ<br>
			ÂêåÁ´ôË∑ØÁ∂´
		</button>
		<button onclick="iframe_handler('${s}',0,'${w}')" class="action-btn">
			‚è±Ô∏è<br>ËªäÁ®ã
		</button>
</div>
<iframe src="${"/eta/v13/bystop.html?color=1&stops="+BusCrawling.getSameStop(s)+"&CHG="+RT_dt.co+"_"+RT_dt.route+"_"+RT_dt.bound}" id="iframe_stop_${s}"></iframe>
<div id="div_stop_${s}"></div>
</div>
`
}

var initalized = [];
var __MARKER_STATS = {
	stopClicked : null,
	markers:[],
	map:null
}
function iframe_map_handler(s,t=null){
	var element;
	if(!t){
	$('#iframe_stop_'+s).hide();
	$('#div_stop_'+s).show();
	
	if(initalized.includes(s))return;
	initalized.push(s);
	// Where you want to render the map.
	element = document.getElementById('div_stop_'+s);
	// Height has to be set. You can do this in CSS too.
	element.style = 'height:400px;';
	}else{
		element = document.getElementById("ROUTEMAP_container");
		element.style = 'height:100%;';
		s = RT_dt.stops[0];
	}

	

	// Create Leaflet map on map element.
	var map = L.map(element);
	__MARKER_STATS.map=map;
	// Add OSM tile layer to the Leaflet map.
	L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
		attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
	}).addTo(map);

	// Target's GPS coordinates.
	var stopdetails = BusCrawling.getStopData(s);
	var target = L.latLng(stopdetails.lat, stopdetails.long);

	// Set map's center to target with zoom 14.
	map.setView(target, 16);

	// Place a marker on the same location.
	//L.marker(target).addTo(map);
	
	var points = [];
	var busstopIcon = L.icon({
    iconUrl: 'icon/stop.png',

    iconSize:     [20, 50], // size of the icon
    iconAnchor:   [10, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50] // point from which the popup should open relative to the iconAnchor
	});

	RT_data.forEach((w,id)=>{
		let currstopdata = BusCrawling.getStopData(w);
		var marker2 = L.marker([currstopdata.lat, currstopdata.long],{icon: busstopIcon})
		marker2.addTo(map);
		__MARKER_STATS.markers.push(marker2);
		points.push([currstopdata.lat, currstopdata.long]);
	
		var popup = marker2.bindPopup((id+1)+". "+currstopdata.name_tc);
		marker2.on('click',function(){
			if(__MARKER_STATS.stopClicked&&__MARKER_STATS.stopClicked.stop==w){
				changePage("ROUTESTOP",document.getElementById("TAB_ROUTESTOP"));
				document.getElementById('rss_'+__MARKER_STATS.stopClicked.stop).scrollIntoView({
				behavior: 'smooth', // ÂèØÈÄâ: 'auto' Êàñ 'smooth'
				block: 'start' // ÂèØÈÄâ: 'start', 'center', 'end', Êàñ 'nearest'
				});
				__MARKER_STATS.stopClicked = null;
			}else{
				__MARKER_STATS.stopClicked = {"id":id,"stop":w};
			}
		});
		if (s == w)popup.openPopup();
	});
	
	if(!RT_dt.data.gtfsId){
		L.polyline(points, {
            color: 'red',    // Line color
            weight: 4,        // Line width
            opacity: 0.5      // Line opacity
        	}).addTo(map);
		return;
	}


	fetch(`https://hkbus.github.io/route-waypoints/${RT_dt.data.gtfsId}-${RT_dt.data.bound[RT_dt.data.co[0]]}.json`).then(g=>g.json()).then(g=>{
		try{
			g.features[0].geometry.coordinates.forEach(w=>{
				//console.log(w);
			L.polyline(w.map(g=>[g[1],g[0]]), {
					color: 'red',    // Line color
					weight: 4,        // Line width
					opacity: 1      // Line opacity
			}).addTo(map)
			}
			)
		}catch(error){
			console.log("Draw ERR: ",error);
			L.polyline(points, {
            color: 'red',    // Line color
            weight: 4,        // Line width
            opacity: 0.5      // Line opacity
        	}).addTo(map);
		}
	})
	
}

function iframe_handler(s,t,w){
	$('#iframe_stop_'+s).show();
	$('#div_stop_'+s).hide();
	$('#iframe_stop_'+s).attr('src',  "/eta/v13/bystop.html?color=1&byrt=" + t + "&stops="+BusCrawling.getSameStop(s,w)+"&CHG="+RT_dt.co+"_"+RT_dt.route+"_"+RT_dt.bound);
}

setInterval(function (){
	try{
	apply_eta(ETA_RESULT)
	}catch(error){console.log(error)}
	try{
		if(TimeDisplay)$("#TimerSettings")[0].innerHTML= `<span>${_T.timeparse(new Date(),{mode:1})}</span>`;
	}catch(error){console.log(error)}
},1000);

setInterval(function (){
if(document.visibilityState=="visible"){
getETA()
}
},45000);

function CTB_eta(rt,bound){	
	var counter = RT_data.length;
	COJOIN_ETA=false;
	var rp = [];
	RT_data.forEach((w,i)=>{
		ETAList.CTB_stop(rt,w,i+1,g=>{
			counter--;
			if (counter==0)apply_eta();
		}, ((RT_dt.bound=="OI" || RT_dt.bound == "IO") && RT_dt.repeat.includes(w)) ? RT_dt.bound[rp.includes(w)?1:0] : RT_dt.bounds.ctb);
		if(RT_dt.repeat && RT_dt.repeat.includes(w))rp.push(w);
	})
}

function NLB_eta(rt,bound,rtid){	
	var counter = RT_data.length;
	COJOIN_ETA=false;
	var rp = [];
	RT_data.forEach((w,i)=>{
		ETAList.NLB_stop(rtid,rt,w,i+1,g=>{
			counter--;
			if (counter==0)apply_eta();
		}, ((RT_dt.bound=="OI" || RT_dt.bound == "IO") && RT_dt.repeat.includes(w)) ? RT_dt.bound[rp.includes(w)?1:0] : RT_dt.bounds.ctb);
		if(RT_dt.repeat && RT_dt.repeat.includes(w))rp.push(w);
	})
}

function getETA(){
	if (RT_data && RT_dt.costops){
		ETAList.KMB_route(RT_dt.route,RT_dt.serviceType,RT_data,RT_dt.bounds.kmb);
		CTB_eta(RT_dt.route,RT_dt.bounds.ctb);
	}else if (RT_dt.co=="KMB"){
		ETAList.KMB_route(RT_dt.route,RT_dt.serviceType,RT_data,RT_dt.bounds.kmb)
	}else if (RT_dt.co=="LRTFEEDER"){
		ETAList.lrtfeeder(RT_dt.route,RT_dt.stops)
	}else if (RT_dt.co=="CTB"){
		CTB_eta(RT_dt.route,RT_dt.bound)
	}else if (RT_dt.co=="NLB"){
		NLB_eta(RT_dt.route,RT_dt.bound,RT_dt.data.nlbId)
	}
}
</script>

</body>
</html> 
