<script>
//v2.1

var input = document.URL.split("kmbeta.html?")[1];


input = input.split(",");
if (input[1]=="inbound"){
var bound="I";
}else{
var bound="O";
}

function httpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}

function timeparse(e){
if (input.length<4)return e.substring(11,16);
if (new Date().getTime() > new Date(e).getTime()) return "即將抵達 "
return ((((new Date(e).getTime() - new Date().getTime() )/1000)<90)?(Math.floor((new Date(e).getTime() - new Date().getTime() )/1000)+" 秒"):(Math.floor((new Date(e).getTime() - new Date().getTime() )/60000))+" 分").padEnd(5," ")
}

var rawresult = 0;
var rreta=0;
var result="";
function data(e){
var rr = JSON.parse(e)["data"];
for (var i in rr){
if(rr[i]["dir"] == bound){
if (rawresult==rr[i]["seq"]){
result+=","+timeparse(rr[i]["eta"])+","+rr[i]["rmk_tc"];
}else{
if (rreta!=0) result+="Δ";
if (rr[i]["eta"]<rreta)result+="*,"
result+=timeparse(rr[i]["eta"])+","+rr[i]["rmk_tc"];
rreta = rr[i]["eta"];
rawresult=rr[i]["seq"];
}
}
}
document.write(result);
window.AppInventor.setWebViewString (result);
}

httpGet("https://data.etabus.gov.hk/v1/transport/kmb/route-eta/"+input[0]+"/"+input[2],function (e){data(e)});
    

</script>
