<script>
//v5

//var input = document.URL.split("changebus.html?")[1];
var input = "1,inbound,ctb,1,11:13,5X.11.5B.101.26.111";

input = input.split(",");
if (input[1]=="i" || input[1]=="inbound" || input[1]=="I"){
var bound="I";
var boundk="O";
}else{
var bound="O";
var boundk="I";
}

function httpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}

function kmbhttpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback([xmlHttp.responseText,xmlHttp.responseURL]);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}

function timediff(a,b){
if(!b)b = new Date();
else  b = new Date(b);
a = new Date(a);
return Math.floor(Math.abs((b-a)/60000));
}

function reduce(e){
    var x = e.split(".");
    var output=[];
    x.forEach(e=>{
        if(e.includes(":")){
            for(var i=parseInt(e.split(":")[0]);i<parseInt(e.split(":")[1]);i++)output.push(i);
                }else{output.push(parseInt(e))}
    })
    return output;
}
var stopseqs = reduce(input[4]);

var route = input[5].split(".");
var routeeta =[];

var orig_rtlist=[];
var target_rtlist =[];
function nwst(e){
var rr = JSON.parse(e)["data"];
rr.forEach(e=>{
orig_rtlist.push(e["stop"]);
if(stopseqs.includes(parseInt(e["seq"]))) target_rtlist.push(e["stop"]);
})
nwstsearcher();
}

var pend=null;
var ng=false;
var wait=2;
function nwstsearcher(){
var f=target_rtlist.shift();
if(f){
wait=2;ng=false;pend=null;
httpGet("https://rt.data.gov.hk/v1/transport/batch/stop-eta/nwfb/"+f+"?lang=zh-hant",function (e){nwstrt(e)});
httpGet("https://rt.data.gov.hk/v1/transport/batch/stop-eta/ctb/"+f+"?lang=zh-hant",function (e){nwstrt(e)});
}
}

var lasteta="0";
var eta=[];
var seq=0;
function nwstrt(e){
wait--;
var rr = JSON.parse(e)["data"];
var sort=rr.filter(e=>e["route"]==input[0]&&e["eta"]>lasteta);
try{

lasteta=sort[0]["eta"];
seq = sort[0]["seq"];
routeeta.push([seq,input[0],timediff(lasteta)]);
ng=true;

}catch(e){}
if(ng){
rr.forEach(e=>{
if(route.includes(e["route"])&&e["eta"]>lasteta&&e["eta"]!="")eta.push([seq,e["route"],e["dir"],e["seq"],e["dest"],e["eta"],timediff(e["eta"],lasteta),e["rmk"],e["co"]]);
if(e["rmk"]=="九巴時段"){
var value1 = kmbroute.filter(f=>e["route"]==f["route"]&&f["service_type"]=="1"&&f["seq"]==e["seq"]&&e["dir"]!=f["bound"]);
if(!kmbfetch.includes(value1[0]["stop"])){
kmbhttpGet("https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/"+value1[0]["stop"]+"?"+lasteta+","+seq,function (e){kmbeta(e)});
kmbfetch.push(value1[0]["stop"])
}
}
});
if(pend){
pend.forEach(e=>{
if(route.includes(e["route"])&&e["eta"]>lasteta&&e["eta"]!="")eta.push([seq,e["route"],e["dir"],e["seq"],e["dest"],e["eta"],timediff(e["eta"],lasteta),e["rmk"],e["co"]]);
if(e["rmk"]=="九巴時段"){
var value1 = kmbroute.filter(f=>e["route"]==f["route"]&&f["service_type"]=="1"&&f["seq"]==e["seq"]&&e["dir"]!=f["bound"]);
console.log(kmbfetch);
if(!kmbfetch.includes(value1[0]["stop"])){
kmbhttpGet("https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/"+value1[0]["stop"]+"?"+lasteta+","+seq,function (e){kmbeta(e)});
kmbfetch.push(value1[0]["stop"]);
}
}
});
}
}else{
pend=rr;
}
if(wait==0){
console.log(eta);

nwstsearcher();
}

}

var kmbroute={};
var kmbfetch=[];
httpGet("https://data.etabus.gov.hk/v1/transport/kmb/route-stop/",function (e){kmb(e)});

httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/route-stop/"+input[2]+"/"+input[0]+"/"+(bound=="I"?"inbound":"outbound"),function (e){nwst(e)});

function kmbeta(e){
var pend = JSON.parse(e[0])["data"];
var lasteta = e[1].split("?")[1].split(",");
pend.forEach(e=>{
if(route.includes(e["route"])&&e["eta"]>lasteta&&e["eta"]!=""&&e["service_type"]==1)eta.push([parseInt(lasteta[1]),e["route"],e["dir"],e["seq"],e["dest_tc"],e["eta"],timediff(e["eta"],lasteta[0]),e["rmk_tc"],"kmb"]);
});
console.log(eta);
}

function kmb(e){
kmbroute = JSON.parse(e)["data"];
}
</script>
