<script>
//v5

//var input = document.URL.split("changebus.html?")[1];
//var input = "101,outbound,kcn,nwfb,8:11,8:11,*";
function f(){
var input = document.getElementById("i").value;
var rtname = document.getElementById("d").value.split(",");
input = input.split(",");
input[2] = input[2].toLowerCase();
if (input[1]=="i" || input[1]=="inbound" || input[1]=="I"){
var bound="I";
var boundk="O";
}else{
var bound="O";
var boundk="I";
}

function httpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback([xmlHttp.responseText,xmlHttp.responseURL]);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}


function timediff(a,b){
if(!b)b = new Date();
else  b = new Date(b);
a = new Date(a);
return Math.floor(Math.abs((b-a)/60000));
}

function reduce(e){
    var x = e.split(".");
    var output=[];
    x.forEach(e=>{
        if(e.includes(":")){
            for(var i=parseInt(e.split(":")[0]);i<parseInt(e.split(":")[1])+1;i++)output.push(i);
                }else{output.push(parseInt(e))}
    })
    return output;
}
var nwstseq = reduce(input[4]);
var kmbseq  = reduce(input[5]);
var routes   = input[6].split(".");
var estoutput = 0;
if(input[2].includes("k"))estoutput+=kmbseq.length;
if(input[2].includes("c"))estoutput+=nwstseq.length;
if(input[2].includes("n"))estoutput+=nwstseq.length;

httpGet("https://data.etabus.gov.hk/v1/transport/kmb/route-stop/"+input[0]+"/"+(input[3]=="kmb"?input[1]:(input[1]=="inbound"?"outbound":"inbound"))+"/1",function (e){kmbroutelist(e)});
if(input[2])
httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/route-stop/"+input[3]+"/"+input[0]+"/"+input[1],function (e){nwstroutelist(e)});

//routelist generator
var kmbstopid=[];
var nwststopid=[];
function kmbroutelist(e){
var rr = JSON.parse(e[0])["data"];
rr.forEach(e=>{
kmbstopid.push(e["stop"]);
if(input[2].includes("k"))
if(kmbseq.includes(parseInt(e["seq"]))) {
httpGet("https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/"+e["stop"],function (e){eta(e)});
}
})
}

function nwstroutelist(e){
var rr = JSON.parse(e[0])["data"];
rr.forEach(e=>{
nwststopid.push(e["stop"]);
if(nwstseq.includes(parseInt(e["seq"]))){
if(input[2].includes("n"))
httpGet("https://rt.data.gov.hk/v1/transport/batch/stop-eta/nwfb/"+e["stop"]+"?lang=zh-hant",function (e){eta(e)});
if(input[2].includes("c"))
httpGet("https://rt.data.gov.hk/v1/transport/batch/stop-eta/ctb/"+e["stop"]+"?lang=zh-hant",function (e){eta(e)});
}
})
}

var result=[];
function eta(f){
estoutput--;
var rr=JSON.parse(f[0])["data"];
rr.forEach(e=>{
if(routes.includes(e["route"])||routes.includes("*"))
if((e["service_type"]?e["service_type"]==1:true))
if((e["eta"]&&e["rmk"]!="九巴時段")||e["route"]==input[0]){
result.push([(e["stop"]?e["stop"]:f[1].split("eta/")[1]),e["route"],e["dir"],e["seq"],(e["dest"]?e["dest"]:e["dest_tc"]),e["eta"],(e["rmk"]?e["rmk"]:e["rmk_tc"]),e["co"]])
}else{
if(e["co"]!="KMB" && !kmbalreadyask.includes(e["route"]+e["stop"]) && e["route"]!=input[0]){
estoutput++;
kmbalreadyask.push(e["route"]+e["stop"]);
httpGet("https://data.etabus.gov.hk/v1/transport/kmb/route-eta/"+e["route"]+"/1?"+e["stop"]+","+e["dir"]+","+e["seq"],function (e){kmbeta(e)});
}
}
})
output();
}

var kmbalreadyask=[];
function kmbeta(f){
estoutput--;
var rr=JSON.parse(f[0])["data"];
var stop = f[1].split("?")[1].split(",");
rr=rr.filter(e=>e["dir"]!=stop[1]&&e["seq"]==stop[2]);
rr.forEach(e=>{
result.push([stop[0],e["route"],e["dir"],e["seq"],e["dest_tc"],e["eta"],e["rmk_tc"],e["co"]])
})
output();
}

var seqweta={};
function output(){
if(estoutput<1){
var result2=result.slice();
var stop_dict = {};
var target_rt=result.filter(e=>e[1]==input[0]);
target_rt.forEach(e=>{stop_dict[e[0]]=e[3]});
target_rt.sort((a,b)=>{
if(a[3]==b[3])return (a[5]<b[5]?-1:1);
else return (a[3]<b[3]?-1:1);
});
for (var i=0;i<result2.length;i++){
result2[i].unshift(stop_dict[result2[i][0]]);
}
var lasteta="0";var lastetaseq=0;
console.log(target_rt);
target_rt.forEach(e=>{
if(e[4]!=lastetaseq && lasteta<e[6]){
seqweta[e[0]] = e[6];
lasteta = e[6];
lastetaseq = e[4];
}
})
result2.forEach(e=>{
if(e[6]){
e.unshift(timediff(seqweta[e[0]],e[6]));
e.push(timediff(seqweta[e[1]]));
}else {
e.unshift(999);
e.push(999);
}
})
result2.sort((a,b)=>{return (a[0]<b[0]?-1:1)})

result2.forEach(e=>{
if(e[2].length!=6){
var length = result2.filter(g=>g[1]==e[1]&&g[2].length==6);
e[2] = length[0][2];
}
e[11]= rtname.filter(g=>g.split(",")[0]==e[2])[0];
})
var result3="";
result2.forEach(e=>{
result3+=e[3].padEnd(4," ")+"往 "+e[6]+","+e[1]+". "+e[11]+"\n"+e[10].toString().padEnd(3," ")+"分 -> "+e[0].toString().padEnd(3," ")+"分"+(e[8]?e[8]:"")+","+e[9]+"Δ";
})
console.log(result3);
}
}

}
</script>
<body>
     <input type="text" id="i">
      <input type="text" id="d">
<button id="b" onclick="f()">提交</button>
    
</body>
