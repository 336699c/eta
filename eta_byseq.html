<script>
//v2.1

var input = document.URL.split("eta_byseq.html?")[1];


input = input.split(",");
var runtimes = input.length-2;
var runs = 0;

function httpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}
function kmbhttpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback([xmlHttp.responseText,xmlHttp.responseURL.split("stop-eta/")[1]]);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}


function timeparse(e){
if (e===null)return e;
if (input[1]=="0")return e.substring(11,16);
if (new Date().getTime() > new Date(e).getTime()) return "即將抵達 ";
if(((new Date(e).getTime() - new Date().getTime())/1000)<90)return (Math.floor((new Date(e).getTime() - new Date().getTime() )/1000)+" 秒").padEnd(5," ");
if(((new Date(e).getTime() - new Date().getTime())/1000)<300)return ((Math.floor((new Date(e).getTime() - new Date().getTime() )/60000))+" 分 "+ Math.floor((new Date(e).getTime() - new Date().getTime() )%60000/1000)).padEnd(5," ");
return (Math.floor((new Date(e).getTime() - new Date().getTime() )/60000)+" 分").padEnd(5," ");
}


var result = "";
function nwst(e){
var rr = JSON.parse(e)["data"];
for (var i in rr){
result += "Δ"+rr[i]["eta"]+"Γ"+rr[i]["route"].padEnd(5," ")+","+rr[i]["co"]+","+rr[i]["dir"]+","+rr[i]["seq"]+","+rr[i]["stop"]+","+timeparse(rr[i]["eta"])+","+rr[i]["rmk"]+","+rr[i]["dest"];
}
runs++;
if (runs==runtimes){
output(result);
}
}

function kmb(e){
var rr = JSON.parse(e[0])["data"];
for (var i in rr){
if (rr[i]["service_type"]=="1"){
result +="Δ"+rr[i]["eta"]+"Γ"+rr[i]["route"].padEnd(5," ")+",KMB,"+rr[i]["dir"]+","+rr[i]["seq"]+","+e[1]+","+timeparse(rr[i]["eta"])+","+rr[i]["rmk_tc"]+","+rr[i]["dest_tc"];
}
}
runs++;
if (runs==runtimes){
output(result);
}
}

function output(e){
var rr=e.split("Δ");
rr.sort();
var p="";
rr.shift();
for (var i in rr)p+=rr[i].split("Γ")[1]+"Δ";
document.write(p);
window.AppInventor.setWebViewString (p);
}

for (var i in input){
if (i>1){
if (input[i].length==6){
runtimes++;
httpGet("https://rt.data.gov.hk/v1/transport/batch/stop-eta/ctb/"+input[i]+"?lang=zh-hant",function (e){nwst(e)});
httpGet("https://rt.data.gov.hk/v1/transport/batch/stop-eta/nwfb/"+input[i]+"?lang=zh-hant",function (e){nwst(e)});
}else{
kmbhttpGet("https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/"+input[i],function (e){kmb(e)});
}
}
}    

</script>
