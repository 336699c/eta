<script>
//v2.1

if(window.AppInventor){
var input = window.AppInventor.getWebViewString();
}else{
var input = document.URL.split("nwstroute.html?")[1];
}
input = input.split(",");
if (input[1]=="inbound"){
var bound="I";
}else{
var bound="O";
}

var result="";
var run=0;
var runtimes = 999;
var temp={};
var t=[];
var etaseq1={};

function httpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}

function timeparse(e){
if (input.length<4)return e.substring(11,16);
if (new Date().getTime() > new Date(e).getTime()) return "即將抵達 "
return ((((new Date(e).getTime() - new Date().getTime() )/1000)<90)?(Math.floor((new Date(e).getTime() - new Date().getTime() )/1000)+" 秒"):(Math.floor((new Date(e).getTime() - new Date().getTime() )/60000))+" 分").padEnd(5," ")
}

function etaget(e){
var rr = JSON.parse(e)["data"];
var rt = "";
var stop=0;
if (rr.length>0){
for (var j in rr){
if(rr[j]["dir"]==bound){
if (rr[j]["eta_seq"]==1)etaseq1[rr[j]["seq"]] = rr[j]["eta"];

rt+= rr[j]["seq"]+","+ rr[j]["rmk_tc"]+","+ timeparse(rr[j]["eta"])+"Γ";
stop = rr[j]["stop"];
}
}
}
temp[stop] = rt+"Δ";
run++;

if (runtimes<run+1){
var x=0;
for (var i in t){
if(temp[t[i]]){
x++;
if (x!=1 && (etaseq1[x] < etaseq1[x-1]))result+="*,";
console.log(i+" 　"+(etaseq1[x-1] > etaseq1[x])+"\n"+etaseq1[x-1] +"\n"+etaseq1[x]+" "+x);

result+= temp[t[i]];

}else{
result+= "null,Δ"
}
}
document.write(result);
window.AppInventor.setWebViewString (result);
}
}

function data(e){
var rr = JSON.parse(e)["data"];
runtimes = Object.keys(rr).length;
for (var i in rr){
t.push(rr[i]["stop"])
httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/eta/"+input[2]+"/"+rr[i]["stop"]+"/"+input[0],function (e){etaget(e)});
}
}

httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/route-stop/"+input[2]+"/"+input[0]+"/"+input[1],function (e){data(e)});
    

</script>
