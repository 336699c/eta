<script>
//v2.1

//var input = document.URL.split("mtr.html?")[1];
const line={
"AEL":"機場快綫",
"TCL":"東涌綫",
"TML":"屯馬綫",
"TKL":"將軍澳綫"
}
const AEL = ["HOK","KOW","TSY","AIR","AWE"];
const TCL = ["HOK","KOW","OLY","NAC","LAK","TSY","SUN","TUC"];
const TML = ["WKS","MOS","HEO","TSH","SHM","CIO","STW","CKT","TAW","HIK","DIH","KAT","SUW","TKW","HOM","HUH","ETS","AUS","NAC","MEF","TWW","KSR","YUL","LOP","TIS","SIH","TUM"];
const TKL = ["NOP","QUB","YAT","TIK","TKO","LHP","HAH","POA"];

const dict={
"HOK":"香港","KOW":"九龍","TSY":"青衣","AIR":"機場站","AWE":"博覽館站",
"OLY":"奧運","NAC":"南昌","LAK":"荔景","SUN":"欣澳","TUC":"東涌",
"LHP":"康城","POA":"寶琳","HAH":"坑口","TKO":"將軍澳","TIK":"調景嶺","YAT":"油塘","QUB":"鰂魚涌","NOP":"北角",
"TUM":"屯門","SIH":"兆康","TIS":"天水圍","LOP":"朗屏","YUL":"元朗","KSR":"錦上路","TWW":"荃灣西","MEF":"美孚","AUS":"柯士甸","ETS":"尖東","HUH":"紅磡","HOM":"何文田","TKW":"土瓜灣","SUW":"宋皇臺","KAT":"啟德","DIH":"鑽石山","HIK":"顯徑","TAW":"大圍","CKT":"車公廟","STW":"沙田圍","CIO":"第一城","SHM":"石門","TSH":"大水坑","HEO":"恆安","MOS":"馬鞍山","WKS":"烏溪沙"
}

var input = document.URL.split("mtr.html?")[1];
//var input ="TML,0";
input = input.split(",");
var runtimes = eval(input[0]).length;
var runs = 0;

function httpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}


function timeparse(e){
if (e===undefined)return "undefined";
if (input[1]=="0")return e.substring(10,16);
if (new Date().getTime() > new Date(e).getTime()) return "即將抵達 "
return ((((new Date(e).getTime() - new Date().getTime() )/1000)<90)?(Math.floor((new Date(e).getTime() - new Date().getTime() )/1000)+" 秒"):(Math.floor((new Date(e).getTime() - new Date().getTime() )/60000))+" 分").padEnd(5," ")
}

function compare(e,r,u){
if (e===undefined)return "";
if (r===undefined)return "";
if (e==0 || r==0)return "";
if (u=='up'){
return (e>r?"*":"")
}else{
return (r>e?"*":"")
}
}

var up={};
var down={};
var delay={};
var upd={};
var downd={};
function data(e){
var rr = JSON.parse(e)["data"];
var station = Object.keys(rr)[0].split("-")[1];
var j = rr[Object.keys(rr)[0]];
if (j["UP"]) 	{up[station] = j["UP"][0]["time"];upd[station] = dict[j["UP"][0]["dest"]];}
if (j["DOWN"]) 	{down[station] = j["DOWN"][0]["time"];downd[station] =dict[j["DOWN"][0]["dest"]];}
delay[station] = JSON.parse(e)["isdelay"];
runs++;
if (runs==runtimes){
var upf = 0;
var downf = 0;
var result="";
for (i in array){
result +=delay[array[i]]+","+compare(upf,up[array[i]],"up")+","+compare(downf,down[array[i]],"down")+","+dict[array[i]]+" , "+timeparse(up[array[i]]).padEnd(5," ")+" , "+upd[array[i]]+" , "+timeparse(down[array[i]]).padEnd(5," ")+" , "+downd[array[i]]+"Δ";
upf = up[array[i]];
downf = down[array[i]];
}
document.write(result);
window.AppInventor.setWebViewString (result);
}
}

var array = eval(input[0]);
for (var i in array){
httpGet("https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line="+input[0]+"&sta="+array[i]+"&lang=TC",function (e){data(e)});
}
</script>
