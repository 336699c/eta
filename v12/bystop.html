
<!DOCTYPE html>
<html>
<head>
<style>
td , th {
  text-align: left;
  padding: 7px;
  font-family: system-ui;
}

td:nth-child(1) {
width:10%;
}
td:nth-child(2) {
width:70%;
}
td:nth-child(3,4) {
width:10%;
}

tr:nth-child(even) {
  background-color: #dddddd;
}

</style>
</head>
<body>
<pre id="Next_bus stop" style="font-size:4vw;"></pre>
<table id="P">
<tbody></tbody>
</table>
</body>
</html> 

<script>
// WEBSITE for v12
// SCRIPT v2
var input = document.URL.split(".html?")[1];
//var input = "1,001137,7421C8745B4EDF25";

  var cookie_data={};
input = input.split(",");
if(input[0][0]=="!"){
var i2 = parseInt(input[0].replace("!",""));
var ck = document.cookie.split("; ");
ck = ck.filter(e=>e.split("=")[0]=="bkmark");
if(ck.length>0){ck = JSON.parse(ck[0].split("=")[1]);}else{ck = [];}
input.shift();
ck[i2].forEach(e=>{input.push(e[1]);cookie_data[e[1]]=e[2];})
}
var runtimes = 0;
var runs = 0;

function httpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}
function kmbhttpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback([xmlHttp.responseText,xmlHttp.responseURL.split("stop-eta/")[1]]);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}


function timeparse(e){
if (e===null)return e;
if (input[0]=="0")return e.substring(11,16);
if (new Date().getTime() > new Date(e).getTime()) return "即將抵達 ";
if(((new Date(e).getTime() - new Date().getTime())/1000)<90)return (Math.floor((new Date(e).getTime() - new Date().getTime() )/1000)+" 秒").padEnd(5," ");
if(((new Date(e).getTime() - new Date().getTime())/1000)<480)return ((Math.floor((new Date(e).getTime() - new Date().getTime() )/60000))+" 分 "+ (Math.floor((new Date(e).getTime() - new Date().getTime() )%60000/1000)).toString().padStart(2,"0")+" 秒").padEnd(5," ");
return (Math.floor((new Date(e).getTime() - new Date().getTime() )/60000)+" 分").padEnd(5," ");
}


var result = "";
function nwst(e){
var rr = JSON.parse(e)["data"];
for (var i in rr){
result += "Δ"+rr[i]["eta"]+","+rr[i]["route"].padEnd(5," ")+","+rr[i]["co"]+","+rr[i]["dir"]+","+rr[i]["seq"]+","+rr[i]["stop"]+","+rr[i]["rmk"]+","+rr[i]["dest"];
}
runs++;
if (runs==runtimes){
output(result);
}
}

function kmb(e){
var rr = JSON.parse(e[0])["data"];
for (var i in rr){
if (rr[i]["service_type"]=="1"){
result +="Δ"+rr[i]["eta"]+","+rr[i]["route"].padEnd(5," ")+",KMB,"+rr[i]["dir"]+","+rr[i]["seq"]+","+e[1]+","+rr[i]["rmk_tc"]+","+rr[i]["dest_tc"];
}
}
runs++;
if (runs==runtimes){
output(result);
}
}

var rr=null;
var showcase_mode=0;
function output(e){
while(document.getElementById("P").childNodes.length>0){document.getElementById("P").childNodes[0].remove()};
rr=e.split("Δ");
rr=rr.filter(e=>e[0]!=",");
console.log(rr);
rr.sort();
rr.shift();
rr.reverse();
rr.forEach((e,i)=>{
e=e.split(/,/g);
var row = document.getElementById("P").insertRow(0);
//row.insertCell(0).innerHTML=`<button style="font-size:3vw">距離</button>`;
let input4getbuseta = JSON.stringify([e[1].trim(),e[3],e[2].toLowerCase(),e[4]]);

row.insertCell(0).innerHTML=`<button style="font-size:3vw" onclick=getbus_eta('`+input4getbuseta+`')>站點</button>`;
row.insertCell(0).innerHTML =
`<td><pre style="font-size:6vw;display: inline;">`+
e[1]+`</pre><pre id="destination_`+i+`" style="font-size:4vw;display: inline;">`+(Object.keys(cookie_data).length>0&&showcase_mode?cookie_data[e[5]]:" 往 "+e[7])+(e[6]?"\n"+e[6]:"")+`</pre><br><pre style="display: inline;font-size:5vw;color:#444" id="Timer_`+i+`">`+
timeparse(e[0])+
`</pre></td>`;

row.insertCell(0).innerHTML = 
`<img src="https://raw.githubusercontent.com/336699c/eta/6077ce3b95f0483094c1795b25302848f47cd9b3/icon/`+e[2].toLowerCase()+`.png" style="width:100%;min-width:50px">`;

})
}

setInterval(function (){
if(document.visibilityState=="visible"){
try{
showcase_mode++;
showcase_mode=showcase_mode%15;
rr.forEach((e,i)=>{
e=e.split(/,/g);
document.getElementById("Timer_"+i).innerHTML = timeparse(e[0]);

document.getElementById("destination_"+i).innerHTML = (Object.keys(cookie_data).length>0&&showcase_mode>5?cookie_data[e[5]]:" 往 "+e[7])+(e[6]?"\n"+e[6]:"");

})
}catch(error){console.log(error)}
}else{console.log("off-screen")}
},1000);

setInterval(function (){
if(document.visibilityState=="visible"){
reload();console.log("RELOAD");
}else{console.log("off-screen")}
},45000);

reload();
function reload(){
runs=0;result="";runtimes = input.length-1;
for (var i in input){
if (i>=1){
if (input[i].length==6){
runtimes++;
httpGet("https://rt.data.gov.hk/v1/transport/batch/stop-eta/ctb/"+input[i]+"?lang=zh-hant",function (e){nwst(e)});
httpGet("https://rt.data.gov.hk/v1/transport/batch/stop-eta/nwfb/"+input[i]+"?lang=zh-hant",function (e){nwst(e)});
}else{
kmbhttpGet("https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/"+input[i],function (e){kmb(e)});
}
}
}   
}
</script>

<script>
var routelist = [];
var pointer,INPUT;
var lasteta = "9999";
var valid = null;
var data1 = [];

function getbus_eta(input){
//[rt_number,inbound,co,station_no]
//input = ["10","inbound","ctb","9"];
input = JSON.parse(input);
INPUT=input;
pointer = parseInt(input[3])-1;
lasteta="9999";
routelist=[];
valid = null;
data1 = [];

buspos=[];
lastseq=0;


if(input[2]=="KMB" || input[2]=="kmb"){

if(input[1]=="outbound")input[1]="O";
if(input[1]=="inbound")input[1]="I";
httpGet("https://data.etabus.gov.hk/v1/transport/kmb/route-eta/"+input[0]+"/1",function (e){data2(e)});

}else{
if(input[1]=="O")input[1]="outbound";
if(input[1]=="I")input[1]="inbound";
httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/route-stop/"+input[2]+"/"+input[0]+"/"+input[1],function (e){data(e)});

}
}




function data(e){
var rr = JSON.parse(e)["data"];
rr.forEach(f=>{routelist.push(f["stop"]);});

httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/eta/"+INPUT[2]+"/"+routelist[pointer]+"/"+INPUT[0],function (e){grabeta(e)});
}

function grabeta(e){
var rr = JSON.parse(e)["data"];
console.log(rr);
if((!rr[0] || rr[0]["eta"]<lasteta) && new Date(rr[0]["eta"]).getTime() > new Date().getTime()&& pointer>0){
pointer--;
lasteta = (rr[0]?rr[0]["eta"]:lasteta);
valid = [rr[0]["stop"],rr[0]["seq"],rr[0]["route"],rr[0]["dest_tc"],rr[0]["rmk_tc"]];
var x = "*下一班 "+ valid[2] +"（"+timeparse(lasteta)+", "+(parseInt(INPUT[3])-parseInt(valid[1]))+"站）\n位於 #"+ valid[1] +(valid[4]?"\n"+valid[4]:"");
if(rr[0]["seq"]>(parseInt(INPUT[3])-1))lasteta="9999";
document.getElementById("Next_bus stop").innerHTML=x;
httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/eta/"+INPUT[2]+"/"+routelist[pointer]+"/"+INPUT[0],function (e){grabeta(e)});
}else{
if(rr[0]["seq"]){
httpGet("https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/stop/"+valid[0],function (e){output2(e)});
}
}
}

function output2(e){
console.log(e);
var rr = JSON.parse(e)["data"];
var x = "下一班 "+ valid[2] +"（"+timeparse(lasteta)+", "+(parseInt(INPUT[3])-parseInt(valid[1]))+"站） 位於 "+ valid[1] +". "+rr["name_tc"]+(valid[4]?"\n"+valid[4]:"");
document.getElementById("Next_bus stop").innerHTML=x;
}


//kmb


var result_kmbeta=[0];
var buspos=[];
var lastseq=0;

function data2(e){
var rr = JSON.parse(e)["data"];
for (var i in rr){
if(rr[i]["dir"] == INPUT[1]){
if(lastseq!=rr[i]["seq"]){
lastseq = rr[i]["seq"];
if (rr[i]["eta"]<result[result.length-1][0] && timeparse2(rr[i]["eta"])){buspos.push(rr[i]["seq"]);}
result_kmbeta.push([(timeparse2(rr[i]["eta"])?rr[i]["eta"]:'999'),rr[i]["rmk_tc"],rr[i]["seq"],rr[i]["dest_tc"]]);
}
}
}

console.log(result_kmbeta);
buspos = buspos.filter(e=>e<parseInt(INPUT[3]));
buspos.unshift(1);
console.log(buspos);
lastseq = buspos.pop();

if(INPUT[1]=="O")INPUT[1]="outbound";
if(INPUT[1]=="I")INPUT[1]="inbound";
httpGet("https://data.etabus.gov.hk/v1/transport/kmb/route-stop/"+INPUT[0]+"/"+INPUT[1]+"/1",function (e){rt_stop(e)});
}

function rt_stop(e){
var rr = JSON.parse(e)["data"][lastseq-1]["stop"];
httpGet("https://data.etabus.gov.hk/v1/transport/kmb/stop/"+rr,function (e){stop(e)});
}

function stop(e){
var rr = JSON.parse(e)["data"]["name_tc"];
var tt = result_kmbeta[lastseq];
var x = "下一班 "+ INPUT[0] +"（"+timeparse(tt[0])+", "+(-parseInt(tt[2])+parseInt(INPUT[3]))+"站） 位於 "+ tt[2] +". "+rr+(tt[1]?"\n"+tt[1]:"");
document.getElementById("Next_bus stop").innerHTML=x;
}


function timeparse2(e){
if (e===null)return false;
return (new Date(e).getTime() - new Date().getTime())>0
}

</script>
