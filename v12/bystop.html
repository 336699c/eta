<!DOCTYPE html>
<html>
<head>
<style>
td , th {
  text-align: left;
  padding: 7px;
  font-family: system-ui;
}

td:nth-child(odd) {
width:15%;
}
td:nth-child(even) {
width:85%;
}

tr:nth-child(even) {
  background-color: #dddddd;
}

</style>
</head>
<body>
<table id="P">
<tbody></tbody>
</table>
</body>
</html> 

<script>
//v12
var input = document.URL.split(".html?")[1];
//var input = "1,001136";

  var cookie_data={};
input = input.split(",");
if(input[0][0]=="!"){
var i2 = parseInt(input[0].replace("!",""));
var ck = document.cookie.split("; ");
ck = ck.filter(e=>e.split("=")[0]=="bkmark");
if(ck.length>0){ck = JSON.parse(ck[0].split("=")[1]);}else{ck = [];}
input.shift();
ck[i2].forEach(e=>{input.push(e[1]);cookie_data[e[1]]=e[2];})
}
var runtimes = 0;
var runs = 0;

function httpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}
function kmbhttpGet(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback([xmlHttp.responseText,xmlHttp.responseURL.split("stop-eta/")[1]]);
    }
    xmlHttp.open("GET", theUrl, true); 
    xmlHttp.send(null);
}


function timeparse(e){
if (e===null)return e;
if (input[0]=="0")return e.substring(11,16);
if (new Date().getTime() > new Date(e).getTime()) return "即將抵達 ";
if(((new Date(e).getTime() - new Date().getTime())/1000)<90)return (Math.floor((new Date(e).getTime() - new Date().getTime() )/1000)+" 秒").padEnd(5," ");
if(((new Date(e).getTime() - new Date().getTime())/1000)<480)return ((Math.floor((new Date(e).getTime() - new Date().getTime() )/60000))+" 分 "+ (Math.floor((new Date(e).getTime() - new Date().getTime() )%60000/1000)).toString().padStart(2,"0")+" 秒").padEnd(5," ");
return (Math.floor((new Date(e).getTime() - new Date().getTime() )/60000)+" 分").padEnd(5," ");
}


var result = "";
function nwst(e){
var rr = JSON.parse(e)["data"];
for (var i in rr){
result += "Δ"+rr[i]["eta"]+","+rr[i]["route"].padEnd(5," ")+","+rr[i]["co"]+","+rr[i]["dir"]+","+rr[i]["seq"]+","+rr[i]["stop"]+","+rr[i]["rmk"]+","+rr[i]["dest"];
}
runs++;
if (runs==runtimes){
output(result);
}
}

function kmb(e){
var rr = JSON.parse(e[0])["data"];
for (var i in rr){
if (rr[i]["service_type"]=="1"){
result +="Δ"+rr[i]["eta"]+","+rr[i]["route"].padEnd(5," ")+",KMB,"+rr[i]["dir"]+","+rr[i]["seq"]+","+e[1]+","+rr[i]["rmk_tc"]+","+rr[i]["dest_tc"];
}
}
runs++;
if (runs==runtimes){
output(result);
}
}

var rr=null;
function output(e){
while(document.getElementById("P").childNodes.length>0){document.getElementById("P").childNodes[0].remove()};
rr=e.split("Δ");
rr.sort();
rr.shift();
rr.reverse();
rr.forEach((e,i)=>{
e=e.split(/,/g);
  console.log(e);
var row = document.getElementById("P").insertRow(0);
row.insertCell(0).innerHTML =
`<td><pre style="font-size:6vw;display: inline;">`+
e[1]+"  "+e[7]+`</pre><br><pre style="display: inline;font-size:5vw;color:#444" id="Timer_`+i+`">`+
timeparse(e[0])+
`</pre></td>`;

row.insertCell(0).innerHTML = 
`<img src="https://raw.githubusercontent.com/336699c/eta/6077ce3b95f0483094c1795b25302848f47cd9b3/icon/`+e[2].toLowerCase()+`.png" style="width:100%;min-width:50px">`;

})
}

setInterval(function (){
if(document.visibilityState=="visible"){
try{
rr.forEach((e,i)=>{
e=e.split(/,/g);
document.getElementById("Timer_"+i).innerHTML = timeparse(e[0]);
})
}catch(error){console.log(error)}
}else{console.log("off-screen")}
},1000);

setInterval(function (){
if(document.visibilityState=="visible"){
reload();console.log("RELOAD");
}else{console.log("off-screen")}
},45000);

reload();
function reload(){
runs=0;result="";runtimes = input.length-1;
for (var i in input){
if (i>=1){
if (input[i].length==6){
runtimes++;
httpGet("https://rt.data.gov.hk/v1/transport/batch/stop-eta/ctb/"+input[i]+"?lang=zh-hant",function (e){nwst(e)});
httpGet("https://rt.data.gov.hk/v1/transport/batch/stop-eta/nwfb/"+input[i]+"?lang=zh-hant",function (e){nwst(e)});
}else{
kmbhttpGet("https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/"+input[i],function (e){kmb(e)});
}
}
}   
}
</script>
